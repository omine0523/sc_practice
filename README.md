# sc_practice

## 概要
sc_practiceは、シンプルな書籍管理アプリです。
以下の機能があります。
- 一覧の表示
- 書籍の検索
- 書籍の登録

## テーブル定義
| RDBMS | データベース名| 作成日 |
|:---|:---|:---|
|MySQL|practice|2026/01/07|

### テーブル情報
| No. | スキーマ名 | 論理テーブル名 | 物理テーブル名 | 区分 | 
|:---|:---|:---|:---|:---|
|1|booksearch|書籍情報|book_info|table|
|2|booksearch|ジャンル|genre|table|
|3|booksearch|置き場所|storage_location|table|

## 技術スタック
本プロジェクトの技術スタックは以下の通りです。
- 言語：Java 21
- フレームワーク：Spring Frameworkバージョン：3.5.9
- DB：MySQL
- DBアクセス：MyBatis 3.0.5（SQLベースのデータアクセスフレームワーク）

## 学習した内容
### PG改善
- コメントは処理の目的を明確にする。
- フォームクラスからサービスクラスに渡す場合、橋渡しとなるバリューオブジェクトを作成した。

### AOPの設定
- Service層の全メソッドを対象にメソッド開始〜終了までの処理時間を計測する
- SLF4J ＋ logbackにてログ出力する。
- SQLの内容を表示するログについてはDB側のログ出力設定を行い確認する。
- トランザクション管理を行い、DBへの処理内容によって分離レベル設定する
- 例外発生時にロールバックが実行されトランザクションログを出力する。

### コネクションプールの設定
あらかじめ複数のDB接続を保持する。  
メリット：アプリがDB接続を行う際に保持している接続情報を再利用してDB接続時の負荷や処理時間を削減する。  


- 設定内容

| 設定項目 | 設定内容 | 設定理由 |
|:---|:---|:---|
|使用するCP|HikariCP|軽量・高速・安全で設定がシンプル。実運用実績も多いためHikariCPで運用する。|
|接続できる最大数|5本|利用者が少ないため接続できる最大数を少なめに設定し負荷を軽減する。|
|常に待機させておく接続数|3本|アクセスが来た時に備え常に待機させておき高速に接続を行う。少なめに設定し負荷を軽減する。|
|接続取得の待ち時間（タイムアウトまでの時間）|30秒|30秒経過したらエラーを返してDB障害時に永遠に待たないようにする。|
|未使用の接続を破棄するまでの時間|10分|DBのリソースを無駄に使わないように設定する。作り直す負荷と無駄に保持する時間のバランスを考慮して10分経過後に破棄する。|
|接続したままを使い続けられる最大寿命|30分|長時間使い続けた接続は不安定になりやすいため再接続を行う。DB側の接続破棄より少し短い30分を寿命として設定する。|

【ブラウザで接続情報を確認方法】  
アプリ起動後に以下の項目のリンクにアクセスする。

| 項目 | リンク |
|:---|:---|
|使用中の接続本数|http://localhost:8080/actuator/metrics/hikaricp.connections.active|
|待機中の接続本数|http://localhost:8080/actuator/metrics/hikaricp.connections.idle|

### SQLログ関連
- general_logの中のSQLクエリログ確認する。  
  トランザクションが開始されたときのBEGIN、ロールバックのログを確認する。  
  Spring + MyBatisの実装だとBEGINは表示されないことが多くSET autocommit=0でトランザクションを開始する。
- Springコンソールの設定を追加しMyBatisが発行するSQLをログ出力する。

### 例外処理
アプリ使用中に例外が発生した際に、処理を一元化してエラー画面に遷移させるグローバル例外ハンドラを作成した。
- 業務例外に対して全て共通のメッセージを表示してエラー画面に遷移させる。
- 書籍登録処理でDB操作中の例外が発生した場合は業務例外にラップして投げ直し、専用の例外クラスからグローバル例外ハンドラに例外を渡して、エラー画面と登録失敗メッセージを表示する。
  
